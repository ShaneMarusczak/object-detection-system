# ==============================================================================
# EVENT-DRIVEN ARCHITECTURE CONFIGURATION
# ==============================================================================
# This config demonstrates the new declarative event system where:
# - Events are defined once and specify ALL their behavior
# - Actions compose like AWS primitives (digest + photos = auto frame capture)
# - No filtering at consumer level - events are pre-filtered by dispatcher
# - Clean separation: geometry (lines/zones) vs. events vs. actions
# ==============================================================================

# ==============================================================================
# DETECTION SETTINGS
# ==============================================================================
detection:
  model_file: "yolo11n.pt"

  # track_classes is derived from event definitions!
  # No need to specify - the dispatcher builds this from events below
  track_classes: []  # Will be auto-populated from events

  confidence_threshold: 0.25


# ==============================================================================
# REGION OF INTEREST (ROI)
# ==============================================================================
roi:
  horizontal:
    enabled: true
    crop_from_left_pct: 0
    crop_to_right_pct: 45

  vertical:
    enabled: true
    crop_from_top_pct: 5
    crop_to_bottom_pct: 95


# ==============================================================================
# GEOMETRY DEFINITIONS - Clean, no tags!
# ==============================================================================
# Lines and zones are pure geometry - events reference them by description

lines:
  - type: vertical
    position_pct: 25
    description: "traffic boundary"
    allowed_classes: [2, 3, 5, 7]  # car, motorcycle, bus, truck

  - type: vertical
    position_pct: 70
    description: "exit line"
    allowed_classes: [2, 3, 5, 7]

zones:
  - x1_pct: 10
    y1_pct: 20
    x2_pct: 30
    y2_pct: 40
    description: "food bowl"
    allowed_classes: [15, 16]  # cat, dog

  - x1_pct: 40
    y1_pct: 20
    x2_pct: 60
    y2_pct: 40
    description: "water bowl"
    allowed_classes: [15, 16]


# ==============================================================================
# EVENT DEFINITIONS - The Heart of the System
# ==============================================================================
# Each event specifies:
# - match: What raw events to match (event_type, zone/line, object_class)
# - actions: What to do when matched (json_log, email_immediate, email_digest, frame_capture)
#
# AWS-Style Implied Actions:
# - email_digest → auto-enables json_log (digest reads from JSON)
# - email_digest with photos: true → auto-enables frame_capture
# ==============================================================================

events:
  # Example 1: Simple JSON logging only
  - name: "vehicle-exit"
    match:
      event_type: "LINE_CROSS"
      line: "exit line"
      object_class: ["car", "truck", "bus", "motorcycle"]
    actions:
      json_log: true  # Just log to JSON file

  # Example 2: Immediate email notification
  - name: "traffic-boundary-cross"
    match:
      event_type: "LINE_CROSS"
      line: "traffic boundary"
      object_class: ["car", "truck"]
    actions:
      json_log: true  # Must be explicit when not using digest
      email_immediate:
        enabled: true
        cooldown_minutes: 5
        message: "Vehicle crossed traffic boundary"

  # Example 3: Photo digest (shows AWS-style composition!)
  # Because digest "pet_photos_hourly" has photos: true,
  # frame_capture is automatically enabled - no need to specify!
  - name: "cat-food-bowl"
    match:
      event_type: "ZONE_ENTER"
      zone: "food bowl"
      object_class: "cat"
    actions:
      email_digest: "pet_photos_hourly"  # ← This is all you need!
      # json_log: true  ← Auto-enabled (digest needs it)
      # frame_capture: {...}  ← Auto-enabled (digest has photos: true)

  # Example 4: Multiple classes
  - name: "pet-water-bowl"
    match:
      event_type: "ZONE_ENTER"
      zone: "water bowl"
      object_class: ["cat", "dog"]
    actions:
      email_digest: "pet_photos_hourly"

  # Example 5: Daily digest without photos
  - name: "all-traffic"
    match:
      event_type: "LINE_CROSS"
      object_class: ["car", "motorcycle", "bus", "truck"]
    actions:
      email_digest: "traffic_daily"  # Only enables json_log, not frame_capture


# ==============================================================================
# DIGEST CONFIGURATIONS
# ==============================================================================
# Digests aggregate events and send periodic emails
# - photos: true → auto-enables frame_capture (AWS-style composition!)
# - frame_config applies to all events using this digest
# ==============================================================================

digests:
  # Hourly pet activity digest WITH PHOTOS
  - id: "pet_photos_hourly"
    period_minutes: 60
    period_label: "Hourly Pet Activity"
    photos: true  # ← This auto-enables frame_capture for matching events!

    # Frame config for events using this digest
    frame_config:
      cooldown_seconds: 600  # 10 minutes between photos per pet per zone
      storage:
        type: "s3"
        s3:
          bucket: "my-pet-monitoring"
          region: "us-east-1"
          presigned_url_expires: 604800  # 7 days

  # Daily traffic summary WITHOUT PHOTOS
  - id: "traffic_daily"
    period_minutes: 1440  # 24 hours
    period_label: "Daily Traffic Summary"
    photos: false  # No frame_capture needed


# ==============================================================================
# FRAME STORAGE (for non-digest frame captures)
# ==============================================================================
# Default frame storage config for events that enable frame_capture directly
# (not through a digest)
frame_storage:
  type: "local"
  local_dir: "frames"
  # For S3:
  # type: "s3"
  # s3:
  #   bucket: "my-bucket"
  #   region: "us-east-1"
  #   presigned_url_expires: 604800


# ==============================================================================
# TEMP FRAME BUFFERING
# ==============================================================================
# Maintains rolling buffer of recent frames for frame capture
temp_frames_enabled: true
temp_frame_dir: "/tmp/frames"
temp_frame_interval: 5  # Save every 5th frame (~1-2 fps at 30fps input)
temp_frame_max_age_seconds: 30


# ==============================================================================
# OUTPUT SETTINGS
# ==============================================================================
output:
  json_dir: "data"


# ==============================================================================
# CONSOLE OUTPUT
# ==============================================================================
console_output:
  enabled: true
  level: "detailed"  # Options: detailed | summary | silent


# ==============================================================================
# CONSUMERS - Always Running
# ==============================================================================
# Consumers are always enabled - dispatcher routes events to them based on actions
consumers:
  json_writer:
    enabled: true
    prompt_save: true


# ==============================================================================
# NOTIFICATIONS (Email Settings)
# ==============================================================================
notifications:
  enabled: true

  email:
    enabled: true
    smtp_server: "smtp.gmail.com"
    smtp_port: 587
    use_tls: true
    username: "your-email@gmail.com"
    password: "your-app-password"
    from_address: "your-email@gmail.com"
    to_addresses:
      - "your-email@gmail.com"


# ==============================================================================
# CAMERA SETTINGS
# ==============================================================================
camera:
  url: "http://192.168.86.33:4747/video"


# ==============================================================================
# RUNTIME SETTINGS
# ==============================================================================
runtime:
  default_duration_hours: 1.0
  queue_size: 1000
  analyzer_startup_delay: 1
  detector_shutdown_timeout: 5
  analyzer_shutdown_timeout: 10

speed_calculation:
  enabled: false


# ==============================================================================
# HOW THIS WORKS - AWS-Style Primitive Composition
# ==============================================================================
#
# Traditional approach (verbose, manual dependencies):
# ────────────────────────────────────────────────────
# events:
#   - name: "cat-food-bowl"
#     match: {event_type: "ZONE_ENTER", zone: "food bowl", object_class: "cat"}
#     actions:
#       json_log: true  # ← Must remember this for digest
#       email_digest: "pet_photos_hourly"
#       frame_capture:  # ← Must configure this for photos
#         enabled: true
#         cooldown_seconds: 600
#         storage: {...long config...}
#
# New approach (AWS-style, automatic dependencies):
# ──────────────────────────────────────────────────
# events:
#   - name: "cat-food-bowl"
#     match: {event_type: "ZONE_ENTER", zone: "food bowl", object_class: "cat"}
#     actions:
#       email_digest: "pet_photos_hourly"  # ← That's it!
#
# digests:
#   - id: "pet_photos_hourly"
#     photos: true  # ← Automatically enables frame_capture
#     frame_config: {...}  # ← Config lives with digest
#
# What happens automatically:
# 1. email_digest → enables json_log (digest reads JSON)
# 2. photos: true → enables frame_capture (digest shows photos)
# 3. frame_config from digest → passed to frame_capture consumer
#
# Result: Define an event, specify the digest, everything else happens!
# ==============================================================================


# ==============================================================================
# QUICK START EXAMPLES
# ==============================================================================
#
# Traffic Monitoring (JSON only):
# ────────────────────────────────
# events:
#   - name: "vehicle-cross"
#     match: {event_type: "LINE_CROSS", object_class: ["car", "truck"]}
#     actions: {json_log: true}
#
#
# Pet Monitoring with Daily Photo Digest:
# ────────────────────────────────────────
# events:
#   - name: "cat-food-bowl"
#     match: {event_type: "ZONE_ENTER", zone: "food bowl", object_class: "cat"}
#     actions: {email_digest: "daily_photos"}
#
# digests:
#   - id: "daily_photos"
#     period_minutes: 1440
#     period_label: "Daily Pet Activity"
#     photos: true
#     frame_config: {cooldown_seconds: 600}
#
#
# Immediate Alert (No Digest):
# ─────────────────────────────
# events:
#   - name: "doorway-person"
#     match: {event_type: "LINE_CROSS", object_class: "person"}
#     actions:
#       json_log: true
#       email_immediate: {enabled: true, cooldown_minutes: 30}
# ==============================================================================
